name: System Watchdog (Auto-Fix)
on:
  schedule:
    - cron: '*/15 * * * *' # Kiá»ƒm tra má»—i 15 phÃºt
  workflow_dispatch: # Cho phÃ©p báº¡n báº¥m nÃºt fix thá»§ cÃ´ng náº¿u muá»‘n

permissions:
  actions: write
  contents: read

jobs:
  rescue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Last Commit Age
        id: check_age
        run: |
          # Láº¥y timestamp cá»§a commit cuá»‘i cÃ¹ng (giÃ¢y)
          last_commit_time=$(git log -1 --format=%ct)
          current_time=$(date +%s)
          diff=$((current_time - last_commit_time))
          
          echo "GiÃ¢y ká»ƒ tá»« commit cuá»‘i: $diff"
          
          # Náº¿u quÃ¡ 600 giÃ¢y (10 phÃºt) chÆ°a cÃ³ commit -> Coi nhÆ° bá»‹ treo
          if [ $diff -gt 600 ]; then
            echo "status=stuck" >> $GITHUB_OUTPUT
            echo "ğŸš¨ Há»‡ thá»‘ng cÃ³ dáº¥u hiá»‡u bá»‹ treo! Äang kÃ­ch hoáº¡t cá»©u há»™..."
          else
            echo "status=fine" >> $GITHUB_OUTPUT
            echo "âœ… Há»‡ thá»‘ng váº«n Ä‘ang hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh."
          fi
          
      - name: Force Restart Dynamic Stats
        if: steps.check_age.outputs.status == 'stuck'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Sá»­ dá»¥ng GitHub CLI Ä‘á»ƒ kÃ­ch hoáº¡t láº¡i workflow chÃ­nh
          gh workflow run "Update Dynamic Stats"
          echo "ğŸš€ ÄÃ£ Ã©p khá»Ÿi cháº¡y láº¡i 'Update Dynamic Stats'!"
